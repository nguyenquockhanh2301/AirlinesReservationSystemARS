@model ARS.ViewModels.PaymentViewModel
@{
    ViewData["Title"] = "Payment";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-controller="Reservation" asp-action="MyReservations">My Reservations</a></li>
                    <li class="breadcrumb-item"><a asp-controller="Reservation" asp-action="Details" asp-route-id="@Model.Reservation.ReservationID">Reservation Details</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Payment</li>
                </ol>
            </nav>

            <div class="row">
                <div class="col-md-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0"><i class="bi bi-credit-card"></i> Complete Payment</h4>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> You are about to complete payment for reservation <strong>@Model.Reservation.ConfirmationNumber</strong>
                            </div>

                            <h5 class="mb-3">Flight Details</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <th>Flight:</th>
                                    <td>@Model.Reservation.Flight?.FlightNumber</td>
                                </tr>
                                <tr>
                                    <th>Route:</th>
                                    <td>@Model.Reservation.Flight?.OriginCity?.CityName â†’ @Model.Reservation.Flight?.DestinationCity?.CityName</td>
                                </tr>
                                <tr>
                                    <th>Travel Date:</th>
                                    <td>@Model.Reservation.TravelDate.ToString("MMMM dd, yyyy")</td>
                                </tr>
                                <tr>
                                    <th>Passengers:</th>
                                    <td>@(Model.Reservation.NumAdults + Model.Reservation.NumChildren + Model.Reservation.NumSeniors)</td>
                                </tr>
                                <tr>
                                    <th>Class:</th>
                                    <td><span class="badge bg-info">@Model.Reservation.Class</span></td>
                                </tr>
                            </table>

                            <hr />

                            <h5 class="mb-3">Payment Summary</h5>
                            <table class="table">
                                <tr>
                                    <th>Amount Already Paid:</th>
                                    <td class="text-end">$@Model.TotalPaid.ToString("N2")</td>
                                </tr>
                                <tr class="table-warning">
                                    <th><strong>Amount Due:</strong></th>
                                    <td class="text-end"><strong>$@Model.AmountDue.ToString("N2")</strong></td>
                                </tr>
                            </table>

                            <hr />

                            <h5 class="mb-3"><i class="bi bi-wallet2"></i> Payment Method</h5>
                            
                            <div class="payment-methods">
                                <!-- PayPal Payment Button -->
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="bi bi-paypal text-primary"></i> Pay with PayPal</h6>
                                        <p class="text-muted small">Secure payment via PayPal. You can use your PayPal account or credit/debit card.</p>
                                        
                                        <div id="paypal-button-container"></div>
                                        <div id="payment-message" class="mt-3"></div>
                                    </div>
                                </div>

                                <!-- Alternative: Manual Payment (for testing/demo) -->
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="bi bi-cash"></i> Other Payment Methods</h6>
                                        <p class="text-muted small">Contact our support team for alternative payment arrangements.</p>
                                        <a href="mailto:support@airline.com" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-envelope"></i> Contact Support
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card shadow-sm sticky-top" style="top: 20px;">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-shield-check"></i> Secure Payment</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="bi bi-check-circle text-success"></i> SSL Encrypted</li>
                                <li class="mb-2"><i class="bi bi-check-circle text-success"></i> PCI Compliant</li>
                                <li class="mb-2"><i class="bi bi-check-circle text-success"></i> 100% Secure</li>
                                <li class="mb-2"><i class="bi bi-check-circle text-success"></i> Money-back Guarantee</li>
                            </ul>
                            <hr />
                            <p class="small text-muted mb-0">
                                <i class="bi bi-info-circle"></i> Your payment information is protected and never stored on our servers.
                            </p>
                        </div>
                    </div>

                    <div class="card shadow-sm mt-3">
                        <div class="card-body">
                            <h6 class="text-muted">Need Help?</h6>
                            <p class="small mb-2">If you have any questions about payment, please contact our support team.</p>
                            <a href="mailto:support@airline.com" class="btn btn-outline-primary btn-sm w-100">
                                <i class="bi bi-headset"></i> Contact Support
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <a asp-controller="Reservation" asp-action="Details" asp-route-id="@Model.Reservation.ReservationID" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Reservation
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=@Model.PayPalClientId&currency=USD"></script>
    
    <script>
        const reservationId = @Model.Reservation.ReservationID;
        const amountDue = @Model.AmountDue;

        paypal.Buttons({
            style: {
                layout: 'vertical',
                color: 'gold',
                shape: 'rect',
                label: 'paypal'
            },
            
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: amountDue.toFixed(2),
                            currency_code: 'USD'
                        },
                        description: 'Flight Reservation Payment - @Model.Reservation.ConfirmationNumber'
                    }]
                });
            },
            
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(orderData) {
                    // Show processing message
                    document.getElementById('payment-message').innerHTML = 
                        '<div class="alert alert-info"><i class="spinner-border spinner-border-sm me-2"></i>Processing payment...</div>';
                    
                    // Submit payment to server
                    fetch('@Url.Action("ProcessPayPal", "Payment")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: new URLSearchParams({
                            reservationId: reservationId,
                            orderId: orderData.id,
                            payerId: orderData.payer.payer_id,
                            __RequestVerificationToken: document.querySelector('input[name="__RequestVerificationToken"]').value
                        })
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            document.getElementById('payment-message').innerHTML = 
                                '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>' + result.message + '</div>';
                            
                            // Redirect after 2 seconds
                            setTimeout(function() {
                                window.location.href = result.redirectUrl;
                            }, 2000);
                        } else {
                            document.getElementById('payment-message').innerHTML = 
                                '<div class="alert alert-danger"><i class="bi bi-x-circle me-2"></i>' + result.message + '</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('payment-message').innerHTML = 
                            '<div class="alert alert-danger"><i class="bi bi-x-circle me-2"></i>Payment processing failed. Please try again.</div>';
                    });
                });
            },
            
            onError: function(err) {
                console.error('PayPal Error:', err);
                document.getElementById('payment-message').innerHTML = 
                    '<div class="alert alert-danger"><i class="bi bi-x-circle me-2"></i>Payment failed. Please try again or contact support.</div>';
            },
            
            onCancel: function(data) {
                document.getElementById('payment-message').innerHTML = 
                    '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>Payment was cancelled.</div>';
            }
        }).render('#paypal-button-container');
    </script>
    
    <!-- Hidden token for AJAX requests -->
    @Html.AntiForgeryToken()
}
